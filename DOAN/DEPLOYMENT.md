# Deployment Guide

Complete guide for deploying EverShop to Vercel and troubleshooting deployment issues.

## Table of Contents

1. [Deployment Overview](#deployment-overview)
2. [Vercel Setup](#vercel-setup)
3. [CI/CD Pipeline](#cicd-pipeline)
4. [Troubleshooting](#troubleshooting)
5. [Monitoring](#monitoring)
6. [Rollback Procedures](#rollback-procedures)

---

## Deployment Overview

### Architecture

```
GitHub Repository
    ↓
Feature Branch (modules/*)
    ↓
Pull Request
    ↓
CI/CD Tests (GitHub Actions)
    ↓
Preview Deploy (Vercel)
    ↓
Code Review & Approval
    ↓
Merge to Main
    ↓
Production Deploy (Vercel)
    ↓
Live Website
```

### Deployment Stages

#### 1. Preview Deployment
- **Trigger**: Every pull request
- **Environment**: Staging
- **URL**: Automatically generated by Vercel
- **Duration**: Keeps deployment until PR is closed
- **Access**: Team members only

#### 2. Production Deployment
- **Trigger**: Push to `main` branch only
- **Environment**: Production
- **URL**: `https://your-production-url.vercel.app`
- **Duration**: Stays until new deployment
- **Access**: All users

---

## Vercel Setup

### Prerequisites

- Vercel account created
- Project already created on Vercel
- GitHub repository connected
- Team invited to Vercel project

### Step 1: Verify Vercel Project

1. Open [Vercel Dashboard](https://vercel.com/dashboard)
2. Select your project
3. Verify settings:
   - Framework: **Other**
   - Root Directory: **DOAN/EVERSHOP/evershop**
   - Build Command: **npm run build**
   - Output Directory: **packages/evershop/dist**

### Step 2: Configure Environment Variables

In Vercel Dashboard → Settings → Environment Variables, add:

**Production**:
```
DB_HOST=<production-db-host>
DB_PORT=5433
DB_USER=<production-db-user>
DB_PASSWORD=<production-db-password>
DB_NAME=<production-db-name>
NODE_ENV=production
APP_URL=https://your-domain.com
```

**Preview**:
```
DB_HOST=<staging-db-host>
DB_PORT=5433
DB_USER=<staging-db-user>
DB_PASSWORD=<staging-db-password>
DB_NAME=<staging-db-name>
NODE_ENV=staging
APP_URL=https://preview-your-domain.vercel.app
```

### Step 3: Configure GitHub Integration

1. Settings → Git Configuration
2. Verify:
   - [ ] Production branch: **main**
   - [ ] Preview branches: **modules/\***
   - [ ] Ignore build step: **Leave unchecked**

### Step 4: Set GitHub Secrets

Add GitHub Actions secrets for Vercel deployment:

**Repository Settings → Secrets and Variables → Actions**

```
VERCEL_TOKEN=<your-vercel-token>
VERCEL_ORG_ID=<your-org-id>
VERCEL_PROJECT_ID=<your-project-id>
```

To get these values:
1. Go to [Vercel Account Settings](https://vercel.com/account/tokens)
2. Create new token (with scope: Full)
3. Copy `VERCEL_TOKEN`
4. Get `VERCEL_ORG_ID` from team settings
5. Get `VERCEL_PROJECT_ID` from project settings

---

## CI/CD Pipeline

### GitHub Actions Workflows

#### 1. **ci.yml** - Main Pipeline

Runs on every PR and push to main:

```yaml
# On pull request to main:
1. Lint code
2. Run tests
3. Build application
4. Deploy preview to Vercel
5. Post preview URL in PR

# On push to main:
1. Lint code
2. Run tests
3. Build application
4. Deploy to production Vercel
```

#### 2. **nx-affected.yml** - NX Optimization

Runs on PRs to detect changed packages:

```yaml
# Detect affected packages
# Run tests only on changed packages
# Lint only changed packages
# Generate dependency graph
```

### Workflow Status in GitHub

View workflow runs:
1. Open repository
2. Click "Actions" tab
3. Select workflow
4. View job details and logs

**Green checkmark**: ✅ Deployment successful
**Red X**: ❌ Deployment failed

---

## Troubleshooting

### Build Fails on Vercel but Works Locally

**Cause**: Environment difference or missing files

**Solution**:
```bash
# 1. Clear and rebuild locally
npm run compile -- --clean
npm run build

# 2. Check .gitignore
# Make sure essential files are NOT ignored:
# - packages/evershop/dist/ should NOT be ignored if needed
# - node_modules/ should be ignored

# 3. Check vercel.json
# Verify build command and output directory

# 4. Check environment variables
# Add missing env vars in Vercel dashboard
```

### Tests Fail in CI but Pass Locally

**Cause**: Different Node versions or cache issues

**Solution**:
```bash
# 1. Use same Node version as CI
node --version

# 2. Clear cache
npm run test -- --clearCache
rm -rf node_modules/.cache

# 3. Update Node
nvm install 20
nvm use 20

# 4. Reinstall dependencies
npm ci  # Use ci instead of install
```

### Deployment Stuck in Progress

**Cause**: Long running build or timeout

**Solution**:
```bash
# 1. Check build logs in Vercel
# Dashboard → Deployments → Click deployment → Logs

# 2. Optimize build
npm run build -- --skip-minify  # For testing

# 3. Increase timeout in vercel.json
# Add: "buildCommand": "timeout 3600 npm run build"

# 4. Split large builds
# Break into smaller packages using NX
```

### Env Variables Not Loaded

**Cause**: Wrong scope or variable name

**Solution**:
```bash
# 1. Verify variable name in code
// In code: process.env.DB_HOST
// In Vercel: DB_HOST (not NODE_ENV_DB_HOST)

# 2. Check scope in Vercel
# Preview vs Production - add to both if needed

# 3. Redeploy after adding variables
# Click "Redeploy" in Vercel dashboard

# 4. Check runtime
# Some variables only available in Node runtime
```

### Database Connection Fails on Vercel

**Cause**: Network, credentials, or firewall

**Solution**:
```bash
# 1. Verify database is running
psql -h $DB_HOST -U $DB_USER -d $DB_NAME

# 2. Check credentials in Vercel
# Copy exactly from database provider

# 3. Allow Vercel IPs
# Add Vercel IP ranges to database firewall
# (Usually database provider handles this automatically)

# 4. Test connection locally with same env vars
# Create .env.production.local with Vercel values
npm run start
```

### 502 Bad Gateway After Deployment

**Cause**: Application crash or slow startup

**Solution**:
```bash
# 1. Check Vercel logs
# Dashboard → Deployments → Logs

# 2. Verify application starts
npm run start

# 3. Check for unhandled errors
# Add error logging middleware

# 4. Increase memory (if needed)
# Contact Vercel support for higher tier
```

### Port Already in Use Locally

**Solution**:
```bash
# 1. Find process using port 3000
lsof -i :3000          # macOS/Linux
netstat -ano | findstr :3000  # Windows

# 2. Kill process
kill -9 <PID>          # macOS/Linux
taskkill /PID <PID> /F # Windows

# 3. Or use different port
PORT=3001 npm run dev
```

### Hot Reload Not Working

**Solution**:
```bash
# 1. Restart dev server
Ctrl+C to stop
npm run dev to restart

# 2. Check file watching
# Run with explicit watch:
npm run compile -- --watch

# 3. Increase file watchers (Linux)
echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf
sudo sysctl -p

# 4. Clear cache
rm -rf packages/evershop/dist
npm run compile
```

---

## Monitoring

### Vercel Analytics

1. Dashboard → Select project → Analytics
2. Monitor:
   - **Page Load Time** - How fast pages load
   - **First Input Delay** - User interaction responsiveness
   - **Cumulative Layout Shift** - Visual stability
   - **Traffic** - Request volume

### Application Monitoring

Set up monitoring for production:

```bash
# 1. Enable debug logging
NODE_ENV=production DEBUG=app:* npm start

# 2. Monitor database
# Check slow query logs in PostgreSQL

# 3. Monitor errors
# Set up error tracking (e.g., Sentry)
```

### Health Checks

```bash
# Test production endpoint
curl https://your-domain.com/health

# Should return:
# { "status": "ok" }
```

---

## Rollback Procedures

### If Production Deployment Fails

**Immediate Action**:
```bash
# 1. Revert the problematic commit
git revert <commit-hash>
git push origin main

# 2. This automatically triggers new deployment
# which uses the reverted code

# 3. Check Vercel dashboard for deployment status
```

**Verify Rollback**:
```bash
# 1. Check deployment in Vercel
# Should be in progress/done

# 2. Test production URL
curl https://your-domain.com

# 3. Check logs for errors
```

### Manual Rollback in Vercel

If automatic rollback fails:

1. **Vercel Dashboard** → Select project
2. **Deployments** tab
3. Find last known good deployment
4. Click **...** menu → **Promote to Production**
5. Confirm

### Database Rollback

If database migration fails:

```sql
-- Connect to production database
psql -h $DB_HOST -U $DB_USER -d $DB_NAME

-- Check migration status
SELECT * FROM migrations ORDER BY created_at DESC LIMIT 5;

-- Rollback last migration (if supported)
SELECT * FROM migrations ORDER BY created_at DESC LIMIT 1;
-- Then run: DELETE FROM migrations WHERE id = <last_id>;
```

---

## Pre-Deployment Checklist

Before merging to main:

### Code Quality
- [ ] All tests pass locally: `npm run test`
- [ ] Linting passes: `npm run lint`
- [ ] Build succeeds: `npm run build`
- [ ] No TypeScript errors
- [ ] No console errors/warnings

### Code Review
- [ ] At least 1 approval
- [ ] Requested changes resolved
- [ ] CI/CD checks passed
- [ ] Branch is up to date with main

### Testing
- [ ] All new features tested
- [ ] Edge cases covered
- [ ] Database migrations tested
- [ ] API endpoints verified

### Documentation
- [ ] README updated
- [ ] API docs updated
- [ ] Architecture changes documented
- [ ] Database schema updated

### Production Readiness
- [ ] Environment variables configured
- [ ] Database backups created
- [ ] Monitoring set up
- [ ] Rollback plan ready

---

## After Deployment

### Post-Deployment Steps

1. **Verify deployment**:
   ```bash
   curl https://your-domain.com
   # Should return 200 OK
   ```

2. **Test critical flows**:
   - User login
   - Product search
   - Checkout process
   - Admin dashboard

3. **Monitor logs**:
   - Check error rate
   - Monitor response times
   - Watch for failed requests

4. **Notify team**:
   - Post deployment notification
   - Include version/changes
   - Link to deployment

### Performance Monitoring

```bash
# Check website performance
curl -I https://your-domain.com

# Monitor build time
# Dashboard → Deployments → Click deployment → Logs
```

---

## Emergency Contacts

- **Vercel Support**: https://vercel.com/support
- **GitHub Support**: https://support.github.com
- **Team Lead**: [Châu Gia Anh]

---

**Last Updated**: 2025
**Version**: 1.0
